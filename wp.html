<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bird's Eye Perspective</title>
    <script async src="https://docs.opencv.org/4.5.1/opencv.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/glfx.js/0.0.3/glfx.min.js"></script>
    <script src="https://pixijs.download/release/pixi.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <h2>Bird's Eye Perspective Transform</h2>
    <input type="file" id="upload" accept="image/*">
    <select id="library">
        <option value="opencv">OpenCV.js</option>
        <option value="glfx">glfx.js</option>
        <option value="pixi">PixiJS</option>
        <option value="three">Three.js</option>
    </select>
    <button onclick="applyTransform()">Apply Transform</button>

    <canvas id="canvas"></canvas>
    <div id="three-container" style="width: 500px; height: 300px;"></div>

    <script>
        let imgElement = null;

        document.getElementById("upload").addEventListener("change", function(event) {
            const file = event.target.files[0];
            if (!file) return;

            imgElement = new Image();
            imgElement.onload = () => {
                const canvas = document.getElementById("canvas");
                const ctx = canvas.getContext("2d");
                canvas.width = imgElement.width;
                canvas.height = imgElement.height;
                ctx.drawImage(imgElement, 0, 0, imgElement.width, imgElement.height);
            };
            imgElement.src = URL.createObjectURL(file);
        });

        function applyTransform() {
            const selectedLibrary = document.getElementById("library").value;

            if (!imgElement) {
                alert("Please upload an image first.");
                return;
            }

            if (selectedLibrary === "opencv") {
                applyOpenCVTransform();
            } else if (selectedLibrary === "glfx") {
                applyGLFXTransform();
            } else if (selectedLibrary === "pixi") {
                applyPixiTransform();
            } else if (selectedLibrary === "three") {
                applyThreeTransform();
            }
        }

        function applyOpenCVTransform() {
            let src = cv.imread('canvas');
            let dst = new cv.Mat();
            let srcPts = cv.matFromArray(4, 1, cv.CV_32FC2, [0, src.rows, src.cols, src.rows, src.cols * 0.8, 0, src.cols * 0.2, 0]);
            let dstPts = cv.matFromArray(4, 1, cv.CV_32FC2, [0, src.rows, src.cols, src.rows, src.cols, 0, 0, 0]);

            let M = cv.getPerspectiveTransform(srcPts, dstPts);
            cv.warpPerspective(src, dst, M, new cv.Size(src.cols, src.rows));

            cv.imshow('canvas', dst);
            src.delete(); dst.delete(); M.delete();
        }

        function applyGLFXTransform() {
            let canvas = fx.canvas();
            let texture = canvas.texture(imgElement);
            canvas.draw(texture).perspective([0, 0, imgElement.width, 0, 0, imgElement.height, imgElement.width, imgElement.height]).update();
            document.body.appendChild(canvas);
        }

        function applyPixiTransform() {
            let app = new PIXI.Application({ width: imgElement.width, height: imgElement.height });
            document.body.appendChild(app.view);
            let texture = PIXI.Texture.from(imgElement.src);
            let sprite = new PIXI.Sprite(texture);
            sprite.perspective = [0, 0, imgElement.width, 0, 0, imgElement.height, imgElement.width, imgElement.height];
            app.stage.addChild(sprite);
        }

        function applyThreeTransform() {
            document.getElementById("three-container").innerHTML = "";
            let scene = new THREE.Scene();
            let camera = new THREE.PerspectiveCamera(75, 500 / 300, 0.1, 1000);
            let renderer = new THREE.WebGLRenderer();
            renderer.setSize(500, 300);
            document.getElementById("three-container").appendChild(renderer.domElement);

            let texture = new THREE.TextureLoader().load(imgElement.src);
            let geometry = new THREE.PlaneGeometry(imgElement.width, imgElement.height);
            let material = new THREE.MeshBasicMaterial({ map: texture });

            let mesh = new THREE.Mesh(geometry, material);
            mesh.rotation.x = -Math.PI / 4;
            scene.add(mesh);

            camera.position.z = 500;
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
        }
    </script>
</body>
</html>
